<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="referrer" content="no-referrer"><title> Gulp老项目升级为webpack打包及相关优化 · DappWind</title><meta name="description" content="Gulp老项目升级为webpack打包及相关优化 - DappWind"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon_dappwind.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="canonical" href="https://blog.dappwind.com/2019/05/25/index.html"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon_dappwind.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/index.html" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/index.html" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Gulp老项目升级为webpack打包及相关优化</h1><div class="post-info">May 25, 2019</div><div class="post-content"><h1 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h1><ol>
<li><p>vue 和 js 改为webpack打包 </p>
<ul>
<li>升级babel</li>
<li>引入webpack config</li>
<li>添加webpack loader</li>
<li>生成入口列表 entry</li>
<li>结合到gulp流程</li>
<li>增加可视化打包分析</li>
</ul>
</li>
<li><p>开发模式热更新</p>
<ul>
<li>webpack-dev-server</li>
</ul>
</li>
<li><p>vue 拆分多入口 实现按需加载 按需引用vue-component</p>
<ul>
<li>vue 文件入口 为指定入口 </li>
<li>vue-web</li>
<li>vue-mobile</li>
<li>vue-article</li>
<li>vue-home</li>
<li>vue-stock </li>
</ul>
</li>
<li><p>vue 公共资源抽离vue-common</p>
<ul>
<li>增加splitChunks</li>
<li>chunks 设置 只抽取vue部分</li>
</ul>
</li>
<li><p>js 引用方式修改为 从vue引入</p>
<ul>
<li>减少体积</li>
<li>不用手动控制js加载</li>
</ul>
</li>
<li><p>拆分vue路由</p>
</li>
<li><p>lodash 按需引用 去除全局lodash</p>
<ul>
<li>减小体积</li>
<li>避免冲突</li>
</ul>
</li>
<li><p>js资源 preload</p>
<ul>
<li>加快速度</li>
</ul>
</li>
<li><p>vue warning 解决</p>
<ul>
<li>之前的打包方式 不会有warning提示</li>
</ul>
</li>
<li>confirm modal 拆分（暂缓）<ul>
<li>新增的考虑拆分</li>
</ul>
</li>
<li>poliyfill<ul>
<li>单独引用 30k</li>
</ul>
</li>
</ol>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>snowman项目采用<code>pug</code>渲染 + <code>vue</code>渲染结合，vue渲染部分js资源未按需加载，页面加载全部的js</p>
<h1 id="一-vue-和-js-改为webpack打包"><a href="#一-vue-和-js-改为webpack打包" class="headerlink" title="一. vue 和 js 改为webpack打包"></a>一. vue 和 js 改为webpack打包</h1><h2 id="1-升级babel"><a href="#1-升级babel" class="headerlink" title="1.升级babel"></a>1.升级babel</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"devDependencies": &#123;</span><br><span class="line">    "@babel/cli": "^7.4.4",</span><br><span class="line">    "@babel/core": "^7.4.4",</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>.babelrc 改用preset-env<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">"@babel/preset-env"</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"targets"</span>: &#123;</span><br><span class="line">          <span class="attr">"browsers"</span>: [</span><br><span class="line">            <span class="string">"Android &gt;= 4.0"</span>,</span><br><span class="line">            <span class="string">"ios &gt;= 9"</span>,</span><br><span class="line">            <span class="string">"ie 9"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"plugins"</span>: [</span><br><span class="line">    <span class="string">"@babel/plugin-syntax-dynamic-import"</span>,</span><br><span class="line">    <span class="string">"@babel/plugin-transform-runtime"</span>,</span><br><span class="line">    [<span class="string">"import"</span>, &#123;</span><br><span class="line">      <span class="attr">"libraryName"</span>: <span class="string">"lodash"</span>,</span><br><span class="line">      <span class="attr">"libraryDirectory"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="attr">"camel2DashComponentName"</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>node入口babel升级</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'@babel/register'</span>)(&#123;</span><br><span class="line">  presets: [<span class="string">'@babel/preset-env'</span>]</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'@babel/polyfill'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="2-引入webpack-config"><a href="#2-引入webpack-config" class="headerlink" title="2.引入webpack config"></a>2.引入webpack config</h2><p><code>webpack.common.js</code></p>
<p><code>webpack.dev.js</code></p>
<p><code>webpack.prod.js</code></p>
<h4 id="entry-打包入口"><a href="#entry-打包入口" class="headerlink" title="entry 打包入口"></a>entry 打包入口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&apos;vue-web&apos;: &apos;./src/vue/web.js&apos;,</span><br><span class="line">&apos;vue-mobile&apos;: &apos;./src/vue/mobile.js&apos;,</span><br></pre></td></tr></table></figure>
<h2 id="3-添加webpack-loader"><a href="#3-添加webpack-loader" class="headerlink" title="3.添加webpack loader"></a>3.添加webpack loader</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">      loader: <span class="string">'vue-loader'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// this applies to &lt;template lang="pug"&gt; in Vue components</span></span><br><span class="line">      test: <span class="regexp">/\.pug$/</span>,</span><br><span class="line">      oneOf: [</span><br><span class="line">        <span class="comment">// 这条规则应用到 Vue 组件内的 `&lt;template lang="pug"&gt;`</span></span><br><span class="line">        &#123;</span><br><span class="line">          resourceQuery: <span class="regexp">/^\?vue/</span>,</span><br><span class="line">          use: [<span class="string">'pug-plain-loader'</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 这条规则应用到 JavaScript 内的 pug 导入</span></span><br><span class="line">        &#123;</span><br><span class="line">          use: [<span class="string">'pug-loader'</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//   test: /\.(css|less)$/,</span></span><br><span class="line">    <span class="comment">//   use: [MiniCssExtractPlugin.loader, 'css-loader', 'less-loader']</span></span><br><span class="line">    <span class="comment">// &#125;,</span></span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      exclude: <span class="regexp">/(node_modules|bower_components)/</span>,</span><br><span class="line">      <span class="comment">// include: /src/,</span></span><br><span class="line">      loader: <span class="string">'babel-loader?cacheDirectory=true'</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h2 id="4-增加可视化打包分析"><a href="#4-增加可视化打包分析" class="headerlink" title="4.增加可视化打包分析"></a>4.增加可视化打包分析</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.VISU) &#123;</span><br><span class="line">  common.plugins.push(<span class="keyword">new</span> BundleAnalyzerPlugin(&#123;</span><br><span class="line">    analyzerHost: <span class="string">'localhost'</span>,</span><br><span class="line">    analyzerPort: <span class="string">'8080'</span></span><br><span class="line">  &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>npm run visu</code> 即可浏览</p>
<p>分析最开始的vue-web.js 为500k </p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aeddba09f491b9?w=927&amp;h=1145&amp;f=png&amp;s=331827" alt></p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aeddbbeaac50ea?w=1242&amp;h=1255&amp;f=png&amp;s=764666" alt></p>
<p>发现是snbchart和moment-timezone 错误引用造成的</p>
<p>查找问题发现</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aeddc94ec178ca?w=444&amp;h=65&amp;f=png&amp;s=15197" alt></p>
<p>取消错误引用后，减小到350k</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aeddcf98c255d2?w=444&amp;h=586&amp;f=png&amp;s=99865" alt></p>
<h2 id="5-生成入口列表-js-entry"><a href="#5-生成入口列表-js-entry" class="headerlink" title="5.生成入口列表 js entry"></a>5.生成入口列表 js entry</h2><p>目前只有vue文件是webpack 打包的，snowman是多入口 还有很多js文件也要分别打包处理</p>
<p>遍历src/js 获得webpack 入口列表</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getEntrys = <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> entry = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> files = glob.sync(path);</span><br><span class="line">  files.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 获取js名称</span></span><br><span class="line">    <span class="keyword">const</span> name = item.match(<span class="regexp">/.*\/(.*?).js$/</span>)[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">      entry[name] = item;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> entry;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jsEntry = getEntrys(<span class="string">'./src/js/*.js'</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> entry = &#123;</span><br><span class="line">  <span class="string">'vue-web'</span>: <span class="string">'./src/vue/web.js'</span>,</span><br><span class="line">  <span class="string">'vue-mobile'</span>: <span class="string">'./src/vue/mobile.js'</span>,</span><br><span class="line">  ...jsEntry,</span><br><span class="line">  <span class="string">'im'</span>: <span class="string">'./src/js/im/index.js'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>至此webpack打包已经能生成各种js文件，但是还不能运行。所以需要结合到gulp流程</p>
<h2 id="6-结合到gulp流程"><a href="#6-结合到gulp流程" class="headerlink" title="6.结合到gulp流程"></a>6.结合到gulp流程</h2><p>我们的pug文件热更新需要沿用gulp流程</p>
<p>webpack output至 gulp dist/js 目录</p>
<p>生成的文件注意不要加hash， gulp有统一处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">output: &#123;</span><br><span class="line">  filename: <span class="string">'[name].js'</span>,</span><br><span class="line">  path: path.resolve(__dirname, <span class="string">'dist/js'</span>),</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>增加webpack gulp命令</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> webpack <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"><span class="comment">// 载入webpack.config.js文件</span></span><br><span class="line"><span class="keyword">import</span> productConfig <span class="keyword">from</span> <span class="string">'../webpack.prod'</span>;</span><br><span class="line"><span class="keyword">import</span> devConfig <span class="keyword">from</span> <span class="string">'../webpack.dev'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isDev = process.env.NODE_ENV === <span class="string">'development'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    webpack(isDev ? devConfig : productConfig, <span class="function"><span class="keyword">function</span> (<span class="params">err, stats</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.err(err);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改gulpfile</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aede106e581a52?w=871&amp;h=752&amp;f=png&amp;s=162133" alt></p>
<h1 id="二-开发模式热更新"><a href="#二-开发模式热更新" class="headerlink" title="二. 开发模式热更新"></a>二. 开发模式热更新</h1><p>采用 webpack-dev-server</p>
<p>启动在5001端口</p>
<p>为了与gulp dev 模式兼容， writeToDist 为true ，同样写到gulp 目录</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"><span class="keyword">const</span> CopyWebpackPlugin = <span class="built_in">require</span>(<span class="string">'copy-webpack-plugin'</span>);</span><br><span class="line"><span class="keyword">const</span> common = <span class="built_in">require</span>(<span class="string">'./webpack.common.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(common, &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  <span class="comment">// devtool: 'inline-source-map',</span></span><br><span class="line">  devServer: &#123;</span><br><span class="line">    contentBase: <span class="string">'./dist/js'</span>,</span><br><span class="line">    hot: <span class="literal">true</span>,</span><br><span class="line">    writeToDisk: <span class="literal">true</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">'Access-Control-Allow-Origin'</span>: <span class="string">'*'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    host: <span class="string">'0.0.0.0'</span>,</span><br><span class="line">    port: <span class="number">5001</span></span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</span><br><span class="line">    <span class="keyword">new</span> webpack.DefinePlugin(&#123;</span><br><span class="line">      <span class="string">'process.env.NODE_ENV'</span>: <span class="built_in">JSON</span>.stringify(<span class="string">'development'</span>)</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> CopyWebpackPlugin([&#123; <span class="attr">from</span>: <span class="string">'./src/js/lib'</span>, <span class="attr">to</span>: <span class="string">'./'</span> &#125;])</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>output publicPath 设置为0.0.0.0:5001 , 目的是为了热更新的js代码能被正确找到</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output: &#123;</span><br><span class="line">    filename: <span class="string">'[name].js'</span>,</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist/js'</span>),</span><br><span class="line">    publicPath: <span class="string">'http://0.0.0.0:5001/'</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<p>npm script </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;dev&quot;: &quot;npm run gulp-dev &amp; npm run webpack-dev-server&quot;,</span><br></pre></td></tr></table></figure>
<p> 编译界面</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee08ae4f01c2c?w=632&amp;h=228&amp;f=png&amp;s=45807" alt></p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee08e9d707c72?w=578&amp;h=369&amp;f=png&amp;s=64670" alt></p>
<h1 id="三-vue-拆分多入口-实现按需加载"><a href="#三-vue-拆分多入口-实现按需加载" class="headerlink" title="三. vue 拆分多入口 实现按需加载"></a>三. vue 拆分多入口 实现按需加载</h1><p>目前都在一块，没有分页面分路由拆分   所有vue页面都有全部的vue-web.js</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee09c8897f495?w=1406&amp;h=1304&amp;f=png&amp;s=428098" alt></p>
<p>原因在于只写了一个vue入口 src/vue/web.js  所有的vue组件都在这里引用，其实应该拆开</p>
<p>看注释 能看到大概的组件属于哪一页</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee0a12558ea9d?w=649&amp;h=1339&amp;f=png&amp;s=409267" alt></p>
<p>计划先按照主要页面 拆分 </p>
<ul>
<li>文章页</li>
<li>个股页</li>
<li>已登录首页</li>
<li>未登录首页</li>
<li>编辑器页</li>
</ul>
<p>抽取通用的vue.common.js 包含一些所有页面都公用的配置和组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> entry = &#123;</span><br><span class="line">  <span class="string">'vue-web'</span>: <span class="string">'./src/vue/web.js'</span>,</span><br><span class="line">  <span class="string">'vue-mobile'</span>: <span class="string">'./src/vue/mobile.js'</span>,</span><br><span class="line">  <span class="string">'vue-article'</span>: <span class="string">'./src/vue/article.js'</span>,</span><br><span class="line">  <span class="string">'vue-stock'</span>: <span class="string">'./src/vue/stock.js'</span>,</span><br><span class="line">  <span class="string">'vue-home'</span>: <span class="string">'./src/vue/home.js'</span>,</span><br><span class="line">  <span class="string">'vue-home-unsign'</span>: <span class="string">'./src/vue/home-unsign.js'</span>,</span><br><span class="line">  <span class="string">'vue-write'</span>: <span class="string">'./src/vue/write.js'</span>,</span><br><span class="line">  ...jsEntry,</span><br><span class="line">  <span class="string">'im'</span>: <span class="string">'./src/js/im/index.js'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee0aa8041d0de?w=547&amp;h=1276&amp;f=png&amp;s=177301" alt></p>
<p>后续考虑 使用dll将通用的node_modules 打包到一块, 加快打包速度，减少发版后用户端的js更新量。</p>
<h2 id="文章页"><a href="#文章页" class="headerlink" title="文章页"></a>文章页</h2><p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee0ae96790675?w=586&amp;h=344&amp;f=png&amp;s=72204" alt></p>
<p>pug文件中引用</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee0b17be032c7?w=335&amp;h=81&amp;f=png&amp;s=12561" alt></p>
<h2 id="个股页"><a href="#个股页" class="headerlink" title="个股页"></a>个股页</h2><p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee0b380a0708e?w=498&amp;h=920&amp;f=png&amp;s=171637" alt></p>
<p>pug文件中应用</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee0b8557a6d5c?w=296&amp;h=106&amp;f=png&amp;s=12802" alt></p>
<h2 id="已登录首页"><a href="#已登录首页" class="headerlink" title="已登录首页"></a>已登录首页</h2><p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee0bc6769e59a?w=605&amp;h=739&amp;f=png&amp;s=134291" alt></p>
<h2 id="未登录首页"><a href="#未登录首页" class="headerlink" title="未登录首页"></a>未登录首页</h2><p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee0c0f46fbdf0?w=475&amp;h=598&amp;f=png&amp;s=80224" alt></p>
<h1 id="四-抽离公共vue-common"><a href="#四-抽离公共vue-common" class="headerlink" title="四. 抽离公共vue-common"></a>四. 抽离公共vue-common</h1><p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee0c8f98e8208?w=1870&amp;h=942&amp;f=png&amp;s=504587" alt></p>
<p>每个js有很多重复的部分</p>
<p>vue 公共资源抽离vue-common</p>
<p>增加splitChunks</p>
<blockquote>
<p><a href="https://webpack.js.org/plugins/split-chunks-plugin/" target="_blank" rel="noopener">https://webpack.js.org/plugins/split-chunks-plugin/</a></p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee0d2782017cc?w=725&amp;h=679&amp;f=png&amp;s=76483" alt></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      <span class="comment">// 只抽取vue开头的公共部分  为了向下兼容 不抽取 vue-web vue-mobile</span></span><br><span class="line">      chunks (chunk) &#123;</span><br><span class="line">        <span class="keyword">return</span> chunk.name.match(<span class="regexp">/^vue-(?!(mobile|web))/</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 取消自动抽取</span></span><br><span class="line">      minSize: <span class="number">3000000</span>,</span><br><span class="line">      maxAsyncRequests: <span class="number">5</span>,</span><br><span class="line">      maxInitialRequests: <span class="number">3</span>,</span><br><span class="line">      automaticNameDelimiter: <span class="string">'~'</span>,</span><br><span class="line">      name: <span class="literal">true</span>,</span><br><span class="line">      cacheGroups: &#123;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">          minSize: <span class="number">0</span>,</span><br><span class="line">          minChunks: <span class="number">4</span>,</span><br><span class="line">          priority: <span class="number">-10</span>,</span><br><span class="line">          name: <span class="string">'vue-common'</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee0d570378598?w=1246&amp;h=1306&amp;f=png&amp;s=321034" alt></p>
<h1 id="五-js引用方式改为从vue引入"><a href="#五-js引用方式改为从vue引入" class="headerlink" title="五. js引用方式改为从vue引入"></a>五. js引用方式改为从vue引入</h1><p>之前的引用方式</p>
<ul>
<li>文章页</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee110d3a8bbb1?w=271&amp;h=43&amp;f=png&amp;s=6859" alt></p>
<ul>
<li>个股页</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1139ddcba80?w=215&amp;h=38&amp;f=png&amp;s=5330" alt></p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee114f6c267e4?w=440&amp;h=288&amp;f=png&amp;s=49664" alt></p>
<p>之前为了按需加载写的代码 可以不用单独在pug入口文件中写了，直接在 vue/article.js  或者 vue/stock.js 中 引用即可</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee11a7bf8bca7?w=1012&amp;h=835&amp;f=png&amp;s=172108" alt></p>
<p>改变引用方式后的打包图，可以发现 vue-stock 包含了 snbchart 并且 体积小于 之前stock_new.js的体积</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee11c51e08992?w=1249&amp;h=1306&amp;f=png&amp;s=342816" alt></p>
<h1 id="六-拆分vue路由"><a href="#六-拆分vue路由" class="headerlink" title="六. 拆分vue路由"></a>六. 拆分vue路由</h1><p>看下面这个打包图，vue-common中包含了所有的路由，并且发现有个bussiness.js 的模块挺大的，后来发现这个模块只有个股页用到了，所以应该打包到vue-stock 这个文件里</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee13904d5f455?w=884&amp;h=946&amp;f=png&amp;s=157739" alt></p>
<p>分析后发现是vue路由没有拆开的原因</p>
<p>vue/router/index </p>
<p>旧代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> routes;</span><br><span class="line"><span class="keyword">const</span> pathname = <span class="built_in">window</span>.location.pathname.replace(<span class="regexp">/^\/snowman/</span>, <span class="string">''</span>);</span><br><span class="line"><span class="keyword">if</span> (~<span class="string">'/'</span>.indexOf(pathname)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">window</span>.SNOWMAN_LOGIN) &#123;</span><br><span class="line">    routes = <span class="built_in">require</span>(<span class="string">'./home'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/^\/today/</span>.test(pathname)) &#123;</span><br><span class="line">  routes = <span class="built_in">require</span>(<span class="string">'./home'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/^\/u\/\d+\/?$/</span>.test(pathname)) &#123;</span><br><span class="line">  routes = <span class="built_in">require</span>(<span class="string">'./profiles'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/^\/k\/?$/</span>.test(pathname)) &#123;</span><br><span class="line">  routes = <span class="built_in">require</span>(<span class="string">'./search'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/^\/u\/[A-z0-9_]&#123;4,&#125;\/?$/</span>.test(pathname)) &#123;</span><br><span class="line">  routes = <span class="built_in">require</span>(<span class="string">'./profiles'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/^\/center\//</span>.test(pathname)) &#123;</span><br><span class="line">  routes = <span class="built_in">require</span>(<span class="string">'./center'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/^\/[sS]\/([^\/]+)\/detail/</span>.test(pathname)) &#123;</span><br><span class="line">  routes = <span class="built_in">require</span>(<span class="string">'./stock-info'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> routes;</span><br></pre></td></tr></table></figure>
<p>看这种写法是想拆分路由的 只是因为入口一样 无法拆分</p>
<p>现在有了不同的入口 就可以拆分了</p>
<p>改为 </p>
<p>只有个股页 才引用 stock-info</p>
<p>匿名首页 只引用 home</p>
<p>个人页 只引用 profiles</p>
<p>个人中心 只引用 center</p>
<p>搜索 只引用 search</p>
<p>效果如下</p>
<p>vue-common 252 -&gt; 200</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee18aa063dfbc?w=1248&amp;h=1303&amp;f=png&amp;s=359030" alt></p>
<p>可以看到 router 从 vue-common 中消失了 </p>
<p>commponent 大小也减小，拆分到了 需要的js 中  实现按需加载 </p>
<p>common  中的 business 也正确的只打包在 vue-stock 中 </p>
<p>匿名首页 拆分 vue 路由后</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee19152b46692?w=614&amp;h=606&amp;f=png&amp;s=117999" alt></p>
<h1 id="七-lodash按需引用-去除全局lodash"><a href="#七-lodash按需引用-去除全局lodash" class="headerlink" title="七. lodash按需引用 去除全局lodash"></a>七. lodash按需引用 去除全局lodash</h1><p>lodash 多个地方重复引用，并且是全量引用</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1a1dee6ada1?w=1406&amp;h=1304&amp;f=png&amp;s=428098" alt></p>
<p>增加lodash tree shake</p>
<blockquote>
<p><a href="https://www.azavea.com/blog/2019/03/07/lessons-on-tree-shaking-lodash/" target="_blank" rel="noopener">https://www.azavea.com/blog/2019/03/07/lessons-on-tree-shaking-lodash/</a></p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1ac0526b38b?w=914&amp;h=198&amp;f=png&amp;s=53644" alt></p>
<p><code>import foo from &#39;lodash/foo&#39;</code></p>
<p>以这种方式引用才可以tree shake</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1b2c6873e2e?w=583&amp;h=617&amp;f=png&amp;s=106965" alt></p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1b4477dd08b?w=1145&amp;h=1105&amp;f=png&amp;s=285099" alt></p>
<p>从26k降到了6k</p>
<h2 id="使用-babel-plugin-import"><a href="#使用-babel-plugin-import" class="headerlink" title="使用 babel-plugin-import"></a>使用 babel-plugin-import</h2><p>但是每次都手动写，不太方便。</p>
<p>分析原理 <code>import { debounce } from &#39;lodash&#39;</code>这种引用方式不能按需加载的原因为：</p>
<p>其被babel转换为了<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lodash = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</span><br><span class="line"><span class="keyword">var</span> debounce = lodash.debounce;</span><br></pre></td></tr></table></figure></p>
<p>第一句 <code>var lodash = require(&#39;lodash&#39;);</code> 就把所有的lodash都引进来了。</p>
<p>所以我们需要一个插件，能正确的babel转换 </p>
<p><a href="https://github.com/ant-design/babel-plugin-import" target="_blank" rel="noopener"><code>babel-plugin-import</code></a> 就是提供了这么一个功能。</p>
<p>能直接转换为</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> debounce = <span class="built_in">require</span>(<span class="string">'lodash/debounce'</span>);</span><br></pre></td></tr></table></figure>
<p>所以最后我们采用 <code>babel-plugin-import</code>。并增加了lodash的引用路径配置。</p>
<p>采用<code>import { debounce } from &#39;lodash&#39;</code>这种写法即可实现按需加载。</p>
<p>并且引用其他库时，也可以配置按需引用了，比如我们的 <code>snb-lib-jsbridge</code>等。</p>
<h1 id="八-资源preload"><a href="#八-资源preload" class="headerlink" title="八. 资源preload"></a>八. 资源preload</h1><p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1be43b52531?w=2302&amp;h=840&amp;f=png&amp;s=384280" alt></p>
<p>js资源加载时间很靠后</p>
<p>增加link preload</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1c379428566?w=399&amp;h=67&amp;f=png&amp;s=8759" alt></p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1c456192c88?w=1101&amp;h=269&amp;f=png&amp;s=81476" alt></p>
<h1 id="九-目前资源加载情况"><a href="#九-目前资源加载情况" class="headerlink" title="九. 目前资源加载情况"></a>九. 目前资源加载情况</h1><h2 id="匿名首页"><a href="#匿名首页" class="headerlink" title="匿名首页"></a>匿名首页</h2><p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1cda7bd72cb?w=822&amp;h=597&amp;f=png&amp;s=145340" alt></p>
<h2 id="文章页-1"><a href="#文章页-1" class="headerlink" title="文章页"></a>文章页</h2><p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1d3d3192af7?w=864&amp;h=598&amp;f=png&amp;s=139636" alt></p>
<h2 id="个股页-1"><a href="#个股页-1" class="headerlink" title="个股页"></a>个股页</h2><p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1d5a4b310b9?w=803&amp;h=603&amp;f=png&amp;s=149437" alt></p>
<h2 id="已登录首页-1"><a href="#已登录首页-1" class="headerlink" title="已登录首页"></a>已登录首页</h2><p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1d6fef8a465?w=958&amp;h=690&amp;f=png&amp;s=168831" alt></p>
<h2 id="包分析"><a href="#包分析" class="headerlink" title="包分析"></a>包分析</h2><p><img src="https://user-gold-cdn.xitu.io/2019/5/25/16aee1da5d88f986?w=1880&amp;h=947&amp;f=png&amp;s=390644" alt></p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/06/14/index.html" class="prev">PREV</a><a href="/2019/05/21/index.html" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'yuxizhe';
var disqus_identifier = '2019/05/25/';
var disqus_title = 'Gulp老项目升级为webpack打包及相关优化';
var disqus_url = 'https://blog.dappwind.com/2019/05/25/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//yuxizhe.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2020 <a href="https://blog.dappwind.com">DappWind</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script src="https://cdn.jsdelivr.net/gh/yuxizhe/cdn@2.3.1/lib/ga.js"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-101680273-1', {'siteSpeedSampleRate': 100});
ga('send', 'pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?0a04d42963922469197b22ffadf59a50";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script></body></html>